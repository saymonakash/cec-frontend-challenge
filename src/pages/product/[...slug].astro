---
import { Image } from "astro:assets";
import { ChevronLeft, Star } from "@lucide/astro";
import formatSlug from "@/utils/formateSlug";
import type { Product } from "@/types";
import { useProductsData } from "@/composables/useProductsData";

import ProductDetailsCard from "@/components/ProductDetailsCard.astro";
import Spacer from "@/components/Spacer.vue";
import Layout from "@/layouts/Layout.astro";
import ProductDetailsButtons from "@/components/ProductDetailsButtons.vue";

const products = await useProductsData();
export async function getStaticPaths() {
  const products = await useProductsData();
  return products.map((product: Product) => ({
    params: { slug: formatSlug(product.title) },
  }));
}

const { slug } = Astro.params;
const product = products.find(
  (product: Product) => formatSlug(product.title) === slug
);

if (!product) {
  throw new Error(`Product not found for slug: ${slug}`);
}
---

<Layout
  title={`${product.title} - CEC Frontend Challenge`}
  description={product.description}
  image={product.image}
>
  <section class="main-container py-12">
    <div class="flex items-center gap-4">
      <a href="/products" class="secondary-btn">
        <ChevronLeft class="w-5" /> Back to Products</a
      >
    </div>
    <Spacer class="h-6" />
    <div class="grid md:grid-cols-5 grid-cols-1 gap-6 lg:gap-16">
      <div
        class="bg-background/10 rounded-xl overflow-hidden shadow-sm border border-line p-6 group md:col-span-2 md:max-h-[calc(100svh-170px)] min-h-[200px] md:sticky top-20"
      >
        <Image
          src={product.image}
          alt={product.title}
          class="size-full object-contain max-w-100 mx-auto group-hover:scale-105 duration-300"
          height={800}
          width={500}
        />
      </div>
      <div class="md:col-span-3">
        <h1 class="text-3xl md:text-4xl font-semibold max-w-100 md:max-w-150">
          {product.title}
        </h1>
        <Spacer class="h-4 md:h-6" />
        <div class="flex items-center gap-2">
          <div class="flex items-center">
            {
              Array.from({ length: 5 }, (_, index) => (
                <Star
                  fill="currentColor"
                  stroke-width={0}
                  class={`size-4 md:size-6 ${index < product.rating.rate ? "text-secondary" : "text-background"}`}
                />
              ))
            }
          </div>
          <span class="lg:text-lg text-text">({product.rating.count})</span>
        </div>
        <Spacer class="h-4 md:h-6" />
        <h2 class="text-2xl md:text-3xl font-bold">${product.price}</h2>
        <Spacer class="h-4 md:h-6" />
        <div
          class="rounded-xl overflow-hidden shadow-sm border border-line p-4 md:p-6"
        >
          <h3 class="text-xl md:text-2xl font-semibold">Product Description</h3>
          <Spacer class="h-2 md:h-4" />
          <p class="text-text text-sm md:text-base">
            {product.description}
          </p>
        </div>
        <Spacer class="h-4" />
        <ProductDetailsButtons {product} client:load />
        <Spacer class="h-4 md:h-6" />
        <ProductDetailsCard {product} />
      </div>
    </div>
  </section>
</Layout>
